name: RC Bot

on:
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'RC PR number to process'
        required: true
      command:
        description: 'Command to run (release-highlights or release-social-card)'
        required: true
        default: 'release-highlights'

jobs:
  rc-bot:
    # Filter: Only respond to @ribir-bot release-* commands or workflow_dispatch
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event.issue.pull_request && contains(github.event.comment.body, '@ribir-bot') && contains(github.event.comment.body, 'release-'))
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write

    steps:
      - name: Handle Event
        id: event
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get event details for checkout
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            PR_NUMBER="${{ github.event.inputs.pr_number }}"
          else
            PR_NUMBER="${{ github.event.issue.number }}"
          fi

          # Get branch info
          BRANCH=$(gh pr view $PR_NUMBER --json headRefName -q '.headRefName')
          BASE=$(gh pr view $PR_NUMBER --json baseRefName -q '.baseRefName')

          # Validate RC PR
          if [[ "$BASE" != "master" ]] || [[ ! "$BRANCH" =~ ^release-[0-9]+\.[0-9]+\.x$ ]]; then
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "âŒ Not an RC PR"
            exit 0
          fi

          echo "should_run=true" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

      - uses: actions/checkout@v4
        if: steps.event.outputs.should_run == 'true'
        with:
          ref: ${{ steps.event.outputs.branch }}
          fetch-depth: 0
          fetch-tags: true

      - name: Install Rust
        if: steps.event.outputs.should_run == 'true'
        uses: dtolnay/rust-toolchain@stable

      - name: Rust Cache
        if: steps.event.outputs.should_run == 'true'
        uses: Swatinem/rust-cache@v2

      - name: Parse Command
        if: steps.event.outputs.should_run == 'true'
        id: cmd
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "command=${{ github.event.inputs.command }}" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Parse command from comment
          RESULT=$(cargo run --manifest-path tools/ribir-bot/Cargo.toml -- workflow handle-event \
            --dispatch-pr "${{ steps.event.outputs.pr_number }}" \
            --dispatch-command "")
          echo "$RESULT" >> $GITHUB_OUTPUT

      - name: Post Help
        if: steps.event.outputs.should_run == 'true' && steps.cmd.outputs.show_help == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cargo run --manifest-path tools/ribir-bot/Cargo.toml -- workflow post-help \
            --pr "${{ steps.event.outputs.pr_number }}" --bot rc

      # ========================================
      # Release Highlights / Social Card
      # ========================================
      - uses: ./.github/actions/setup-gemini
        if: steps.event.outputs.should_run == 'true' && steps.cmd.outputs.command != 'release-stable'

      - name: Run RC Command (highlights/social-card)
        if: steps.event.outputs.should_run == 'true' && steps.cmd.outputs.command != 'release-stable' && steps.cmd.outputs.should_run == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          COMMAND="${{ steps.cmd.outputs.command }}"
          SUBCMD=$(echo "$COMMAND" | sed 's/release-//')
          CONTEXT="${{ steps.cmd.outputs.context }}"

          cd tools/ribir-bot
          if [ -n "$CONTEXT" ]; then
            cargo run -- release $SUBCMD "$CONTEXT"
          else
            cargo run -- release $SUBCMD
          fi

          cd ../..
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add -A

            if git log -1 --pretty=%B | grep -q "Generated by ribir-bot"; then
              git commit --amend --no-edit
              git push --force-with-lease
            else
              git commit -m "chore(release): regenerate release content

              ðŸ¤– Generated by ribir-bot"
              git push
            fi
          fi

      # ========================================
      # Release Stable
      # ========================================
      - name: Install system dependencies
        if: steps.cmd.outputs.command == 'release-stable'
        run: sudo apt-get update && sudo apt-get install -y libwebp-dev libasound2-dev pkg-config

      - name: Install cargo-release
        if: steps.cmd.outputs.command == 'release-stable'
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-release

      - name: Release Stable
        if: steps.cmd.outputs.command == 'release-stable'
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATE_RELEASE_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          cargo run --manifest-path tools/ribir-bot/Cargo.toml -- release stable

      - name: "[DRY RUN] Merge PR to master"
        if: steps.cmd.outputs.command == 'release-stable'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ”€ [DRY RUN] Would merge PR #${{ steps.event.outputs.pr_number }} to master..."
          echo "âœ… [DRY RUN] Successfully simulated merge"

      - name: Post Release Summary
        if: steps.cmd.outputs.command == 'release-stable'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="${{ steps.event.outputs.branch }}"
          PR_NUMBER="${{ steps.event.outputs.pr_number }}"
          VERSION=$(echo "$BRANCH" | sed -E 's/release-([0-9]+)\.([0-9]+)\.x/\1.\2.0/')

          gh pr comment $PR_NUMBER --body "## ðŸ§ª Stable Release Simulated (Dry-run)

          **Version:** v$VERSION
          **Release:** (Dry-run: GitHub Release was not created)

          The release branch would have been merged to master in a real run.

          ---
          ðŸ¤– Simulated by ribir-bot"
